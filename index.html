<!doctype html>

<html lang="en">
<head>
<meta charset="utf-8">
<title>MLC</title>

<link href="https://maxcdn.bootstrapcdn.com/bootstrap/latest/css/bootstrap.css" rel="stylesheet">

<style>
#input {
	font-family: monospace;
	resize: none;
}

#output {
	white-space: pre-wrap;
}
</style>

<script src="https://code.jquery.com/jquery.js"></script>
<script src="bundle.js"></script>

<script>
let input, output, limit, encoding, prepared, doc, win;

function run()
{
	prepared = false;

	try {
		const max = limit.val();
		const algo = encoding.val();
		const mlc = input.val();
		const result = mlcjs(mlc, algo, max);
		const total = result.total;
		const beta = result.beta;
		const redtime = result.redtime;
		const nf = result.nf;

		output.text([
			result.term,
			`${total}(${beta}), ${redtime} ms`,
			nf ? nf : "?"
		].join("\n\n"));
	} catch (error) {
		output.text(error);
	}
}

function debug()
{
	try {
		const algo = encoding.val();
		const mlc = input.val();

		mlcjs.prepare(mlc, algo);
		prepared = true;
		output.text("Step-by-step evaluation:");
		win.scroll();
	} catch (error) {
		prepared = false;
		output.text(error);
	}
}

function compile()
{
	prepared = false;

	try {
		const algo = encoding.val();
		const mlc = input.val();
		const inet = mlcjs.mlc2in(mlc, algo);

		output.text(inet);
	} catch (error) {
		output.text(error);
	}
}

function more()
{
	return doc.height() - win.scrollTop() < 2 * win.height();
}

function step()
{
	if (!prepared)
		return;

	while (more()) {
		let eqn;

		try {
			eqn = mlcjs.debug();

			if (!eqn) {
				prepared = false;
				return;
			}
		} catch (error) {
			eqn = error;
			prepared = false;
		}

		output.append("\n\n" + eqn);
	}
}

function setup()
{
	const defalgo = mlcjs.defalgo;
	const example = mlcjs.example;

	doc = $(document);
	win = $(window);
	input = $("#input");
	output = $("#output");
	encoding = $("#encoding");
	limit = $("#limit");

	input.attr("rows", example.split("\n").length);
	input.text(example);

	mlcjs.algos.forEach(opt => {
		opt = `<option value="${opt}">${opt}</option>`;
		encoding.append(opt);
	});

	$(`option[value='${defalgo}']`).prop("selected", true);

	limit.val(3e6);
	limit.attr("min", 0);
	limit.attr("max", 1e7);
	limit.attr("step", 1e5);

	$("#run").click(run);
	$("#debug").click(debug);
	$("#compile").click(compile);

	win.scroll(step);
}

$(setup);
</script>
</head>

<body>
<div class="container-fluid">
<div class="row">
<div class="col-sm-10 col-sm-offset-1">
<h2>
Macro Lambda Calculus

<small>
<a href="https://www.npmjs.com/package/@alexo/lambda"><samp>@alexo/lambda</samp></a>
browserified
</small>
</h2>

<div class="form-group">
<textarea id="input" class="form-control"></textarea>
</div>

<div class="form-group form-inline">
<div class="input-group">
<div class="input-group-addon">
<span class="glyphicon glyphicon-cog"></span>
</div>

<select id="encoding" class="form-control">
</select>

<div class="input-group-addon">&le;</div>

<input id="limit" type="number" class="form-control">

<div class="input-group-addon">&#8904;</div>

<span class="input-group-btn">
<button id="run" class="btn btn-danger">Run</button>
<button id="debug" class="btn btn-warning">Debug</button>
<button id="compile" class="btn btn-success">Compile</button>
</span>
</div>
</div>

<p>
<samp id="output"></samp>
</p>

<hr>
</div>
</div>
</div>
</body>
</html>
